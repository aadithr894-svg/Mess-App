{% extends 'base.html' %}
{% block content %}
<div class="container mt-4">

  <h2 class="mb-4 text-center">ðŸ“Š Daily Meal Attendance</h2>

  <!-- Month Filter -->
  <div class="mb-3 text-center">
    <label for="monthFilter" class="form-label me-2">Filter by Month:</label>
    <select id="monthFilter" class="form-select d-inline-block w-auto">
      <option value="all">All</option>
      {% for month in months %}
      <option value="{{ month.value }}">{{ month.name }}</option>
      {% endfor %}
    </select>
  </div>

  <!-- Historical Counts Table -->
  <div class="table-responsive">
    <table class="table table-bordered table-striped" id="attendanceTable">
      <thead class="table-dark">
        <tr>
          <th>Date</th>
          <th>Breakfast</th>
          <th>Lunch</th>
          <th>Dinner</th>
        </tr>
      </thead>
      <tbody>
        {% for row in counts_by_date %}
        <tr data-month="{{ row.month_key }}">
          <td>{{ row.date }}</td>
          <td>{{ row.meals.breakfast }}</td>
          <td>{{ row.meals.lunch }}</td>
          <td>{{ row.meals.dinner }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

</div>

<!-- Auto refresh and month filter -->
<script>
  const monthFilter = document.getElementById('monthFilter');
  const tableRows = document.querySelectorAll('#attendanceTable tbody tr');

  monthFilter.addEventListener('change', () => {
    const selectedMonth = monthFilter.value;
    tableRows.forEach(row => {
      const rowMonth = row.getAttribute('data-month'); // format: YYYY-MM
      if (selectedMonth === 'all' || rowMonth === selectedMonth) {
        row.style.display = '';
      } else {
        row.style.display = 'none';
      }
    });
  });

  // Auto-refresh counts every 2 minutes
  setInterval(() => {
    fetch("/admin/qr_scan_counts_json")
      .then(res => res.json())
      .then(data => {
        console.log("Counts updated:", data);
      });
  }, 120000);
</script>
{% endblock %}
