{% extends "base.html" %}
{% block content %}

<div class="container mt-4">
    <h2 class="mb-4 text-center text-md-start fw-bold" style="font-family: 'Poppins', sans-serif; color: var(--primary);">
        <i class="fas fa-users me-2" style="color: #3498DB;"></i> Users List
    </h2>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert" style="border-radius: var(--radius);">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <div class="mb-4">
        <input type="text" id="searchInput" class="form-control rounded-pill shadow-sm" 
               placeholder="Search by name, ID, or email..." style="border-color: #DDE1E5;">
    </div>

    <div id="usersList" class="row g-4"> {% for user in users %}
        <div class="col-12 col-md-6 col-lg-4 user-card">
            <div class="card shadow-sm custom-card user-card-{{ user.id }}">

                <div class="card-top-bar d-flex justify-content-between align-items-center p-3"
                    data-bs-toggle="collapse" 
                    data-bs-target="#collapseMobile{{ user.id }}" 
                    aria-expanded="false" 
                    aria-controls="collapseMobile{{ user.id }}" 
                    style="cursor: pointer;">
                    <h5 class="mb-0 fw-bold" style="color: var(--text-color); font-size: 1.05rem;">
                        <span class="text-muted small me-2">{{ loop.index }}.</span> {{ user.name }}
                    </h5>
                    <span class="badge rounded-pill fw-semibold text-uppercase
                        {% if user.user_type == 'outmess' %} badge-outmess
                        {% elif user.user_type == 'guest' %} badge-guest
                        {% elif user.user_type == 'inmate' %} badge-inmate
                        {% else %} bg-secondary {% endif %}">
                        {{ user.user_type|capitalize }}
                    </span>
                </div>

                <div class="collapse d-md-block" id="collapseMobile{{ user.id }}">
                    <div class="card-inner p-3 pt-2">
                        <p class="mb-1"><strong>ID:</strong> <span class="text-muted">{{ user.id }}</span></p>
                        <p class="mb-1"><strong>Email:</strong> <span class="text-muted">{{ user.email }}</span></p>
                        <p class="mb-1"><strong>Course:</strong> <span class="text-muted">{{ user.course }}</span></p>
                        <p class="mb-1"><strong>Phone:</strong> <span class="text-muted">{{ user.phone }}</span></p>
                        <p class="mb-1"><strong>Food Type:</strong> <span class="text-muted">{{ user.food_type|capitalize }}</span></p>
                        
                        <form action="{{ url_for('delete_user', user_id=user.id) }}" method="post" 
                              onsubmit="return confirm('Are you sure you want to delete {{ user.name }}? This action cannot be undone.');">
                            <button type="submit" class="btn btn-sm w-100 mt-3 rounded-pill delete-btn">
                                <i class="fas fa-trash-alt me-1"></i> Delete User
                            </button>
                        </form>
                    </div>
                </div>

            </div>
        </div>
        {% endfor %}
    </div>
</div>

<style>
/* Custom Card Styles */
.custom-card {
    background-color: var(--card-bg);
    border-radius: var(--radius);
    border: 1px solid #EAEAEA; /* Light, clean border */
    transition: transform 0.2s, box-shadow 0.2s;
    overflow: hidden;
}

.custom-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1);
}

/* Header bar for click/toggle on mobile */
.card-top-bar {
    background: var(--sidebar-hover); /* Very Light Gray hover color */
    border-bottom: 1px dashed #E0E0E0;
}

/* User Type Badges - Clean, distinct colors */
.badge-inmate {
    background-color: #D6EAF8 !important; /* Soft Light Blue */
    color: #21618C !important;
}
.badge-outmess {
    background-color: #FADBD8 !important; /* Soft Salmon/Red tone */
    color: #943126 !important;
}
.badge-guest {
    background-color: #FCF3CF !important; /* Soft Cream/Yellow tone */
    color: #B7950B !important;
}

/* Delete Button - Using the defined Secondary (Red) Danger Color */
.delete-btn {
    background-color: var(--secondary); /* Muted Red */
    border: none;
    color: white;
    font-weight: 600;
    transition: background-color 0.2s;
    /* Explicitly force full rounded corners for the pill effect */
    border-radius: 50px !important;
}
.delete-btn:hover {
    background-color: #C0392B; /* Darker red on hover */
    color: white;
}

/* Search input style */
#searchInput {
    border-radius: 50px !important;
    border-color: #DDE1E5; /* Light border color */
}

/* Mobile-specific adjustments: Add an indicator for the collapsible content */
@media (max-width: 767.98px) {
    .card-top-bar::after {
        content: '\25BC'; /* Down arrow */
        font-size: 0.8rem;
        transition: transform 0.3s;
        margin-left: 10px;
        color: var(--primary); /* Primary Navy Blue indicator */
    }
    /* Rotate the arrow when the card is open */
    .card-top-bar[aria-expanded="true"]::after {
        transform: rotate(180deg);
    }
}
</style>

<script>
document.getElementById('searchInput').addEventListener('keyup', function() {
    let filter = this.value.toLowerCase();
    let cards = document.querySelectorAll('#usersList .user-card');

    cards.forEach(card => {
        let text = card.textContent.toLowerCase();
        // Check if the card content includes the filter text
        card.style.display = text.includes(filter) ? 'block' : 'none';
    });
});
</script>
{% endblock %}