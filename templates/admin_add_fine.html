{% extends "base.html" %}
{% block content %}

<h2 class="mb-4 text-center">Add Meal Fines</h2>

<!-- Meal type selector -->
<form method="get" action="{{ url_for('add_fine') }}" class="mb-4 d-flex justify-content-center">
  <label for="meal_type" class="me-2 fw-bold">Choose meal:</label>
  <select name="meal_type" id="meal_type" class="form-select w-auto" onchange="this.form.submit()">
    <option value="" {% if not meal_type %}selected{% endif %}>-- Select Meal --</option>
    <option value="breakfast" {% if meal_type=='breakfast' %}selected{% endif %}>Breakfast</option>
    <option value="lunch" {% if meal_type=='lunch' %}selected{% endif %}>Lunch</option>
    <option value="dinner" {% if meal_type=='dinner' %}selected{% endif %}>Dinner</option>
  </select>
</form>

{% if meal_type %}
  {% if non_scanned_users %}
    <form method="POST" id="finesForm" class="card shadow p-3">
      <input type="hidden" name="meal_type" value="{{ meal_type }}">

      <div class="table-responsive">
        <table class="table table-hover align-middle">
          <thead class="table-light">
            <tr>
              <th>#</th>
              <th>Name</th>
              <th>Email</th>
              <th>Fine (â‚¹)</th>
            </tr>
          </thead>
          <tbody>
            {% for user in non_scanned_users %}
            <tr>
              <td>{{ loop.index }}</td>
              <td>{{ user.name }}</td>
              <td>{{ user.email }}</td>
              <td>
                <input type="hidden" name="user_id" value="{{ user.id }}">
                <input type="number" name="fine" step="0.01" min="0"
                       class="form-control fine-input"
                       placeholder="0.00">
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <div class="d-flex justify-content-between mt-3">
        <div class="fw-bold">
          Total Fine: â‚¹<span id="totalFine">0.00</span>
        </div>
        <button type="submit" class="btn btn-primary">
          Save Fines
        </button>
      </div>
    </form>
  {% else %}
    <p class="alert alert-success text-center">
      ðŸŽ‰ No users to fine for {{ meal_type|capitalize }} today.
    </p>
  {% endif %}
{% else %}
  <p class="alert alert-info text-center">
    Please choose a meal above to view non-scanned users.
  </p>
{% endif %}

<!-- Live total calculation -->
<script>
document.addEventListener('input', function (e) {
  if (e.target.classList.contains('fine-input')) {
    let total = 0;
    document.querySelectorAll('.fine-input').forEach(inp => {
      const val = parseFloat(inp.value) || 0;
      total += val;
    });
    document.getElementById('totalFine').textContent = total.toFixed(2);
  }
});
</script>

{% endblock %}
