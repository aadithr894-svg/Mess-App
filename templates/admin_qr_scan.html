{% extends "admin_base.html" %}
{% block content %}
<div class="container mt-4">
  <h2>ðŸ“¡ QR Scanner</h2>
  <div class="mb-3"><strong>Today's Date:</strong> {{ current_date }}</div>

  <!-- Last scanned user -->
  <h4>Last Scanned User</h4>
  <table class="table table-bordered table-striped" id="lastScannedUser">
    <thead>
      <tr>
        <th>Name</th>
        <th>Email</th>
        <th>Course</th>
        <th>Meal</th>
        <th>Total Scans (this meal)</th>
      </tr>
    </thead>
    <tbody>
      <tr><td colspan="5" style="text-align:center;">No scans yet</td></tr>
    </tbody>
  </table>

  <!-- Live Meal Totals -->
  <h4>ðŸ“Š Live Meal Totals</h4>
  <table class="table table-bordered table-striped" id="mealTotals">
    <thead>
      <tr>
        <th>Breakfast</th>
        <th>Lunch</th>
        <th>Dinner</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td id="breakfastTotal">0</td>
        <td id="lunchTotal">0</td>
        <td id="dinnerTotal">0</td>
      </tr>
    </tbody>
  </table>

  <!-- QR Scanner -->
  <div id="reader" style="width:400px;height:300px;border:1px solid #ccc;"></div>
</div>

<script src="https://unpkg.com/html5-qrcode@2.3.10/minified/html5-qrcode.min.js"></script>
<script>
  const lastUserTbody = document.querySelector('#lastScannedUser tbody');

  // Auto-detect meal
  function detectMeal() {
    const now = new Date();
    const hours = now.getHours() + now.getMinutes()/60;
    if(hours >= 7.5 && hours <= 9) return 'breakfast';
    if(hours >= 12 && hours <= 14) return 'lunch';
    return 'dinner';
  }

  function updateLastScanned(data) {
    lastUserTbody.innerHTML = `
      <tr>
        <td>${data.name}</td>
        <td>${data.email}</td>
        <td>${data.course}</td>
        <td>${detectMeal()}</td>
        <td>${data.count}</td>
      </tr>
    `;
  }

  function updateMealTotals(totals) {
    document.getElementById("breakfastTotal").textContent = totals.breakfast;
    document.getElementById("lunchTotal").textContent = totals.lunch;
    document.getElementById("dinnerTotal").textContent = totals.dinner;
  }

  function scanSuccess(qrMessage) {
    fetch('/admin/scan_qr', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ qr_data: qrMessage })
    })
    .then(res => res.json())
    .then(data => {
      if(data.success) {
        updateLastScanned(data);
        updateMealTotals(data.totals);
      } else {
        console.error(data.message);
      }
    })
    .catch(err => console.error(err));
  }

  // QR scanner init
  const html5QrcodeScanner = new Html5Qrcode("reader");
  Html5Qrcode.getCameras().then(cameras => {
    if(cameras && cameras.length) {
      html5QrcodeScanner.start(
        cameras[0].id,
        { fps: 10, qrbox: { width: 250, height: 250 } },
        scanSuccess
      ).catch(err => console.error("QR Scanner failed to start:", err));
    } else console.warn("No cameras found");
  }).catch(err => console.error(err));
</script>
{% endblock %}
