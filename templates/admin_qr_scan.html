{% extends "admin_base.html" %}
{% block content %}
<div class="container mt-4">
  <h2>ðŸ“¡ QR Scanner</h2>
  <video id="preview" width="400"></video>

  <hr>

  <!-- Scanned Users Today -->
  <h4>Scanned Users Today</h4>
  <table class="table table-bordered table-striped" id="scannedUsersTable">
    <thead>
      <tr>
        <th>#</th>
        <th>Name</th>
        <th>Email</th>
        <th>Course</th>
        <th>Total Scans</th>
      </tr>
    </thead>
    <tbody>
      <!-- Rows will be populated by JS -->
    </tbody>
  </table>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/instascan/1.0.0/instascan.min.js"></script>
<script>
  let scannedUsers = {};

  // QR scanner
  let scanner = new Instascan.Scanner({ video: document.getElementById('preview') });
  scanner.addListener('scan', function(content) {
      fetch('/admin/scan_qr', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ qr_data: content })
      })
      .then(res => res.json())
      .then(data => {
          if(data.success){
              alert(`${data.name} scanned successfully! Total: ${data.count}`);

              // Update scannedUsers object
              scannedUsers[data.name] = { 
                  name: data.name, 
                  email: '', // optional, fetch from server if needed
                  course: '', // optional
                  total_scans: data.count 
              };

              renderTable();
          } else {
              alert(data.message);
          }
      });
  });

  Instascan.Camera.getCameras().then(function (cameras) {
      if (cameras.length > 0) {
          scanner.start(cameras[0]);
      } else {
          console.error('No cameras found.');
      }
  }).catch(function (e) {
      console.error(e);
  });

  function renderTable(){
      const tbody = document.querySelector('#scannedUsersTable tbody');
      tbody.innerHTML = '';
      let i = 1;
      for(let key in scannedUsers){
          let u = scannedUsers[key];
          tbody.innerHTML += `<tr>
              <td>${i++}</td>
              <td>${u.name}</td>
              <td>${u.email}</td>
              <td>${u.course}</td>
              <td>${u.total_scans}</td>
          </tr>`;
      }
  }
</script>
{% endblock %}
