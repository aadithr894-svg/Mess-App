<script src="https://cdnjs.cloudflare.com/ajax/libs/instascan/1.0.0/instascan.min.js"></script>
<script>
const scannedUsers = {
    breakfast: {},
    lunch: {},
    dinner: {}
};

// Automatic meal detection
function detectMeal() {
    const now = new Date();
    const hours = now.getHours() + now.getMinutes() / 60;
    if (hours >= 7.5 && hours <= 9) return 'breakfast';
    if (hours >= 12 && hours <= 14) return 'lunch';
    return 'dinner'; // dinner until 23:59
}

// Render last scanned user table
function renderTable(meal) {
    const tbody = document.querySelector(`#${meal}Table tbody`);
    tbody.innerHTML = '';
    let i = 1;
    const today = new Date().toISOString().split('T')[0];
    for (let key in scannedUsers[meal]) {
        const u = scannedUsers[meal][key];
        tbody.innerHTML += `<tr>
            <td>${i++}</td>
            <td>${u.name}</td>
            <td>${u.email}</td>
            <td>${u.course}</td>
            <td>${u.total_scans}</td>
            <td>${today}</td>
        </tr>`;
    }
}

// Initialize scanner
let scanner = new Instascan.Scanner({ video: document.getElementById('preview') });
scanner.addListener('scan', function(content) {
    const meal = detectMeal();

    fetch('/admin/scan_qr', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ qr_data: content, meal_type: meal })
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            scannedUsers[meal][data.name] = {
                name: data.name,
                email: data.email || '',
                course: data.course || '',
                total_scans: data.count
            };
            renderTable(meal);
        }
    })
    .catch(err => console.error(err));
});

// Start camera silently
Instascan.Camera.getCameras().then(cameras => {
    if (cameras.length > 0) scanner.start(cameras[0]);
}).catch(err => console.error(err));
</script>
