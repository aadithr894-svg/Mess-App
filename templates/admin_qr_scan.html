{% extends "admin_base.html" %}
{% block content %}
<div class="container mt-4">
  <h2>ðŸ“¡ QR Scanner</h2>

  <!-- Date display -->
  <div class="mb-3">
    <strong>Today's Date:</strong> {{ current_date }}
  </div>

  <!-- Meal selector -->
  <div class="mb-3">
    <label for="mealType" class="form-label">Select Meal</label>
    <select id="mealType" class="form-select">
      <option value="breakfast">Breakfast (07:30 - 09:00)</option>
      <option value="lunch">Lunch (12:00 - 14:00)</option>
      <option value="dinner">Dinner (19:30 - 23:59)</option>
    </select>
  </div>

  <!-- QR Scanner -->
  <div id="reader" style="width: 400px; height: 300px; border:1px solid #ccc;"></div>

  <hr>

  <!-- Last scanned user -->
  <h4>Last Scanned User</h4>
  <table class="table table-bordered table-striped" id="lastScannedUser">
    <thead>
      <tr>
        <th>Name</th>
        <th>Email</th>
        <th>Course</th>
        <th>Meal</th>
        <th>Total Scans</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td colspan="5" style="text-align:center;">No scans yet</td>
      </tr>
    </tbody>
  </table>
</div>

<!-- Html5 Qrcode -->
<script src="https://unpkg.com/html5-qrcode@2.3.10/minified/html5-qrcode.min.js"></script>
<script>
const lastUserTbody = document.querySelector("#lastScannedUser tbody");

function updateLastScanned(data) {
    lastUserTbody.innerHTML = `
      <tr>
        <td>${data.name}</td>
        <td>${data.email || '-'}</td>
        <td>${data.course || '-'}</td>
        <td>${document.getElementById('mealType').value}</td>
        <td>${data.count}</td>
      </tr>
    `;
}

// Initialize scanner
const html5QrcodeScanner = new Html5Qrcode("reader");

function scanSuccess(qrMessage) {
    fetch('/admin/scan_qr', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ qr_data: qrMessage, meal_type: document.getElementById('mealType').value })
    })
    .then(res => res.json())
    .then(data => {
        if(data.success){
            updateLastScanned(data);
        } else {
            console.error(data.message);
        }
    })
    .catch(err => console.error("Scan error:", err));
}

// Start camera
Html5Qrcode.getCameras().then(cameras => {
    if(cameras && cameras.length){
        html5QrcodeScanner.start(
            cameras[0].id,
            { fps: 10, qrbox: 250 },
            scanSuccess
        ).catch(err => console.error("QR scanner start failed:", err));
    } else {
        console.error("No cameras found.");
    }
}).catch(err => console.error("Camera error:", err));
</script>
{% endblock %}
