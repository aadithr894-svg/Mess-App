{% extends "admin_base.html" %}
{% block content %}
<div class="container mt-4">
  <h2>ðŸ“¡ QR Scanner</h2>
  <video id="preview" width="400"></video>

  <hr>

  <div id="lastUser" class="mt-3"></div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/instascan/1.0.0/instascan.min.js"></script>
<script>
let lastScannedUser = null;

function getMealType() {
    const now = new Date();
    const hours = now.getHours();
    const minutes = now.getMinutes();
    const time = hours*60 + minutes; // total minutes since midnight

    // Breakfast: 07:30 - 09:00 (450 - 540)
    if(time >= 450 && time <= 540) return 'breakfast';
    // Lunch: 12:00 - 14:00 (720 - 840)
    if(time >= 720 && time <= 840) return 'lunch';
    // Dinner: 19:30 - 23:00 (1170 - 1380)
    if(time >= 1170 && time <= 1380) return 'dinner';

    return null; // outside meal time
}

function renderLastUser(){
    const container = document.getElementById('lastUser');
    container.innerHTML = lastScannedUser ? `
        <h4>Last Scanned User</h4>
        <p><b>Name:</b> ${lastScannedUser.name}</p>
        <p><b>Email:</b> ${lastScannedUser.email}</p>
        <p><b>Course:</b> ${lastScannedUser.course}</p>
        <p><b>Meal:</b> ${lastScannedUser.meal_type}</p>
        <p><b>Total Today:</b> ${lastScannedUser.count}</p>
    ` : '';
}

let scanner = new Instascan.Scanner({ video: document.getElementById('preview') });

scanner.addListener('scan', function(content) {
    const mealType = getMealType();
    if(!mealType){
        console.warn("Outside meal time, scan ignored.");
        return;
    }

    fetch('/admin/scan_qr', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ user_id: content, meal_type: mealType })
    })
    .then(res => res.json())
    .then(data => {
        if(data.success){
            lastScannedUser = data;
            renderLastUser();
        } else {
            console.error(data.message);
        }
    });
});

Instascan.Camera.getCameras().then(function(cameras) {
    if(cameras.length > 0){
        let backCam = cameras.find(cam => cam.name.toLowerCase().includes('back') || cam.facing === 'environment');
        if(!backCam) backCam = cameras[0]; 
        scanner.start(backCam);
    } else {
        console.error('No cameras found.');
    }
}).catch(function(e){
    console.error(e);
});
</script>
{% endblock %}
