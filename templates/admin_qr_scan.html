{% extends "admin_base.html" %}
{% block content %}
<div class="container mt-4">
  <h2>ðŸ“¡ QR Scanner - {{ current_date }}</h2>

  <div class="mb-3">
    <label for="mealType">Select Meal:</label>
    <select id="mealType" class="form-control" style="width:250px;">
      <option value="breakfast">Breakfast (7:30-9:00)</option>
      <option value="lunch">Lunch (12:00-14:00)</option>
      <option value="dinner">Dinner (19:30-23:00)</option>
    </select>
  </div>

  <div id="qr-reader" style="width:400px;"></div>

  <hr>
  <h4>Scanned Users Today</h4>
  <table class="table table-bordered table-striped" id="scannedUsersTable">
    <thead>
      <tr>
        <th>#</th>
        <th>Name</th>
        <th>Email</th>
        <th>Course</th>
        <th>Total Scans</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<!-- Html5 QR Code Library -->
<script src="https://unpkg.com/html5-qrcode"></script>
<script>
let scannedUsers = {};

// Initialize QR scanner
function onScanSuccess(decodedText, decodedResult) {
    const meal_type = document.getElementById('mealType').value;

    fetch('/admin/scan_qr', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ qr_data: decodedText, meal_type })
    })
    .then(res => res.json())
    .then(data => {
        if(data.success){
            scannedUsers[data.name] = {
                name: data.name,
                email: data.email || '',
                course: data.course || '',
                total_scans: data.count
            };
            renderTable();
        } else {
            console.error("QR scan error:", data.message);
        }
    })
    .catch(err => console.error(err));
}

function renderTable(){
    const tbody = document.querySelector('#scannedUsersTable tbody');
    tbody.innerHTML = '';
    let i = 1;
    for(let key in scannedUsers){
        const u = scannedUsers[key];
        tbody.innerHTML += `<tr>
            <td>${i++}</td>
            <td>${u.name}</td>
            <td>${u.email}</td>
            <td>${u.course}</td>
            <td>${u.total_scans}</td>
        </tr>`;
    }
}

// Setup html5-qrcode scanner
let html5QrcodeScanner = new Html5Qrcode("qr-reader");
Html5Qrcode.getCameras().then(cameras => {
    if (cameras && cameras.length) {
        html5QrcodeScanner.start(
            cameras[0].id, 
            { fps: 10, qrbox: 250 },
            onScanSuccess
        );
    } else {
        console.error("No cameras found.");
    }
}).catch(err => console.error(err));
</script>
{% endblock %}
