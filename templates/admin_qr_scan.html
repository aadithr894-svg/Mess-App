{% extends "admin_base.html" %}
{% block content %}
<div class="container mt-4">
  <h2>ðŸ“¡ QR Scanner</h2>
  <div id="reader" style="width: 400px;"></div>

  <hr>

  <!-- Meal Type Selector -->
  <div class="mb-3">
    <label for="meal_type">Select Meal:</label>
    <select id="meal_type" class="form-select" style="width:200px;">
      <option value="breakfast">Breakfast (7:30-9:00)</option>
      <option value="lunch">Lunch (12:00-14:00)</option>
      <option value="dinner">Dinner (19:30-23:00)</option>
    </select>
  </div>

  <!-- Scanned User -->
  <h4>Last Scanned User</h4>
  <table class="table table-bordered table-striped" id="scannedUserTable">
    <thead>
      <tr>
        <th>#</th>
        <th>Name</th>
        <th>Email</th>
        <th>Course</th>
        <th>Meal</th>
        <th>Date</th>
      </tr>
    </thead>
    <tbody>
      <!-- Last scanned user row -->
    </tbody>
  </table>
</div>

<script src="https://unpkg.com/html5-qrcode@2.3.10/minified/html5-qrcode.min.js"></script>
<script>
let lastScannedUser = null;

function renderLastUser(user){
    const tbody = document.querySelector('#scannedUserTable tbody');
    tbody.innerHTML = '';
    tbody.innerHTML = `<tr>
        <td>1</td>
        <td>${user.name}</td>
        <td>${user.email || ''}</td>
        <td>${user.course || ''}</td>
        <td>${user.meal}</td>
        <td>${user.date}</td>
    </tr>`;
}

function scanSuccess(qrMessage) {
    const meal_type = document.getElementById('meal_type').value;

    fetch('/admin/scan_qr', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ user_id: qrMessage, meal_type })
    })
    .then(res => res.json())
    .then(data => {
        if(data.success){
            lastScannedUser = {
                name: data.name,
                email: data.email || '',
                course: data.course || '',
                meal: meal_type,
                date: data.date || new Date().toLocaleDateString()
            };
            renderLastUser(lastScannedUser);
        } else {
            console.error(data.message);
        }
    })
    .catch(err => console.error(err));
}

// Configure scanner
let html5QrcodeScanner = new Html5Qrcode("reader");

Html5Qrcode.getCameras().then(cameras => {
    if(cameras && cameras.length){
        // Use back camera if available
        let backCam = cameras.find(cam => cam.label.toLowerCase().includes('back')) || cameras[0];
        html5QrcodeScanner.start(
            backCam.id,
            { fps: 10, qrbox: 250 },
            scanSuccess
        ).catch(err => console.error("QR start failed:", err));
    } else {
        console.error("No cameras found.");
    }
}).catch(err => console.error(err));
</script>
{% endblock %}
