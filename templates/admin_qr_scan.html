{% extends "admin_base.html" %}
{% block content %}
<div class="container mt-4">
    <h2>ðŸ“¡ QR Scanner</h2>
    <p>Date: <span id="todayDate"></span></p>

    <!-- QR Scanner -->
    <div id="reader" style="width: 400px; height: 300px;"></div>

    <hr>

    <!-- Last scanned user -->
    <h4>Last Scanned User</h4>
    <table class="table table-bordered table-striped" id="lastScannedUser">
        <thead>
            <tr>
                <th>Name</th>
                <th>Email</th>
                <th>Course</th>
                <th>Meal</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td colspan="4" style="text-align:center;">No scans yet</td>
            </tr>
        </tbody>
    </table>

    <hr>

    <!-- Counts for each meal -->
    <h4>Meal Counts Today</h4>
    <table class="table table-bordered table-striped" id="mealCounts">
        <thead>
            <tr>
                <th>Meal</th>
                <th>Total Scans</th>
            </tr>
        </thead>
        <tbody>
            <tr><td>Breakfast</td><td id="breakfastCount">0</td></tr>
            <tr><td>Lunch</td><td id="lunchCount">0</td></tr>
            <tr><td>Dinner</td><td id="dinnerCount">0</td></tr>
        </tbody>
    </table>
</div>

<script src="https://unpkg.com/html5-qrcode@2.3.10/minified/html5-qrcode.min.js"></script>
<script>
document.getElementById('todayDate').innerText = new Date().toLocaleDateString();

function detectMeal(){
    let now = new Date();
    let hours = now.getHours();
    let minutes = now.getMinutes();
    let time = hours + minutes/60;

    if(time >= 7.5 && time <= 9){
        return 'breakfast';
    } else if(time >= 12 && time <= 14){
        return 'lunch';
    } else if(time >= 19.5 && time <= 23){
        return 'dinner';
    } else {
        return 'dinner';
    }
}

function updateLastScanned(data){
    const tbody = document.querySelector('#lastScannedUser tbody');
    tbody.innerHTML = `
        <tr>
            <td>${data.name}</td>
            <td>${data.email || '-'}</td>
            <td>${data.course || '-'}</td>
            <td>${detectMeal()}</td>
        </tr>
    `;
}

function updateMealCounts(data){
    const meal = detectMeal();
    document.getElementById(meal + 'Count').innerText = data.count;
}

function scanSuccess(qrMessage){
    fetch('/admin/scan_qr', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ user_id: qrMessage, meal_type: detectMeal() })
    })
    .then(res => res.json())
    .then(data => {
        if(data.success){
            updateLastScanned(data);
            updateMealCounts(data);
        } else {
            console.error(data.message);
        }
    })
    .catch(err => console.error(err));
}

// Initialize scanner
const html5QrcodeScanner = new Html5Qrcode("reader");
Html5Qrcode.getCameras().then(cameras => {
    if(cameras && cameras.length){
        html5QrcodeScanner.start(
            cameras[0].id,
            { fps: 10, qrbox: { width: 250, height: 250 } },
            scanSuccess,
            errorMessage => {
                // optional: handle scan errors
            }
        ).catch(err => console.error("QR scanner start failed:", err));
    } else {
        console.error("No cameras found.");
    }
}).catch(err => console.error("Camera error:", err));
</script>
{% endblock %}
