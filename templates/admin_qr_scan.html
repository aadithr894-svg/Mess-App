{% extends "admin_base.html" %}
{% block content %}
<div class="container mt-4">
  <h2>üì° QR Scanner</h2>

  <!-- Date display -->
  <div class="mb-3">
    <strong>Today's Date:</strong> {{ current_date }}
  </div>

  <!-- Inline message -->
  <div id="scanMessage" class="mb-3"></div>

  <!-- Meal selector -->
  <div class="mb-3">
    <label for="mealType" class="form-label">Select Meal</label>
    <select id="mealType" class="form-select">
      <option value="breakfast">Breakfast (7:30 - 9:00)</option>
      <option value="lunch">Lunch (12:00 - 14:00)</option>
      <option value="dinner">Dinner (19:30 - 21:15)</option>
    </select>
  </div>

  <video id="preview" width="400" style="border:1px solid #ccc;"></video>

  <hr>

  <!-- Scanned Users Tables -->
  <h4>Scanned Users</h4>
  <div id="mealTables">
    {% for meal in ['breakfast', 'lunch', 'dinner'] %}
    <h5>{{ meal.capitalize() }}</h5>
    <table class="table table-bordered table-striped" id="{{ meal }}Table">
      <thead>
        <tr>
          <th>#</th>
          <th>Name</th>
          <th>Email</th>
          <th>Course</th>
          <th>Total Scans</th>
          <th>Date</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    {% endfor %}
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/instascan/1.0.0/instascan.min.js"></script>
<script>
  const scannedUsers = {
    breakfast: {},
    lunch: {},
    dinner: {}
  };

  const mealTimes = {
    breakfast: { start: "07:30", end: "09:00" },
    lunch: { start: "12:00", end: "14:00" },
    dinner: { start: "19:30", end: "21:15" }
  };

  const msgDiv = document.getElementById("scanMessage");
  const mealSelect = document.getElementById("mealType");

  function timeToMinutes(t) {
    const [h, m] = t.split(":").map(Number);
    return h * 60 + m;
  }

  function isWithinSlot(meal) {
    const now = new Date();
    const currentMinutes = now.getHours() * 60 + now.getMinutes();
    const slot = mealTimes[meal];
    return currentMinutes >= timeToMinutes(slot.start) && currentMinutes <= timeToMinutes(slot.end);
  }

  function renderTable(meal){
    const tbody = document.querySelector(`#${meal}Table tbody`);
    tbody.innerHTML = '';
    let i = 1;
    const today = new Date().toISOString().split('T')[0];
    for(let key in scannedUsers[meal]){
      let u = scannedUsers[meal][key];
      tbody.innerHTML += `<tr>
        <td>${i++}</td>
        <td>${u.name}</td>
        <td>${u.email}</td>
        <td>${u.course}</td>
        <td>${u.total_scans}</td>
        <td>${today}</td>
      </tr>`;
    }
  }

  // QR scanner
  let scanner = new Instascan.Scanner({ video: document.getElementById('preview') });
  scanner.addListener('scan', function(content) {
      const selectedMeal = mealSelect.value;

      if(!isWithinSlot(selectedMeal)){
        msgDiv.innerHTML = `<span class="text-danger">‚ùå Cannot scan ${selectedMeal} outside its time slot.</span>`;
        setTimeout(() => { msgDiv.innerHTML = ''; }, 3000);
        return;
      }

      fetch('/admin/scan_qr', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ qr_data: content, meal_type: selectedMeal })
      })
      .then(res => res.json())
      .then(data => {
          if(data.success){
              msgDiv.innerHTML = `<span class="text-success">‚úÖ ${data.name} scanned for ${selectedMeal}. Total: ${data.count}</span>`;

              scannedUsers[selectedMeal][data.name] = {
                name: data.name,
                email: data.email || '',
                course: data.course || '',
                total_scans: data.count
              };

              renderTable(selectedMeal);
          } else {
              msgDiv.innerHTML = `<span class="text-danger">‚ùå ${data.message}</span>`;
          }

          setTimeout(() => { msgDiv.innerHTML = ''; }, 3000);
      })
      .catch(err => {
          msgDiv.innerHTML = `<span class="text-danger">‚ùå Error scanning QR code.</span>`;
          setTimeout(() => { msgDiv.innerHTML = ''; }, 3000);
          console.error(err);
      });
  });

  // Start camera
  Instascan.Camera.getCameras().then(function (cameras) {
      if (cameras.length > 0) scanner.start(cameras[0]);
      else msgDiv.innerHTML = `<span class="text-warning">‚ö†Ô∏è No cameras found.</span>`;
  }).catch(function (e) {
      msgDiv.innerHTML = `<span class="text-danger">‚ùå ${e}</span>`;
      console.error(e);
  });
</script>
{% endblock %}
