{% extends "admin_base.html" %}
{% block content %}
<div class="container mt-4">
  <h2>üì° QR Scanner</h2>
  <div id="reader" style="width: 400px; margin-bottom: 20px;"></div>

  <hr>

  <!-- Scanned Users Today -->
  <h4>Scanned Users Today</h4>
  <table class="table table-bordered table-striped" id="scannedUsersTable">
    <thead>
      <tr>
        <th>#</th>
        <th>Name</th>
        <th>Email</th>
        <th>Course</th>
        <th>Total Scans</th>
      </tr>
    </thead>
    <tbody>
      <!-- Rows will be populated by JS -->
    </tbody>
  </table>
</div>

<!-- Include html5-qrcode library -->
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
<script>
let scannedUsers = {};

// Automatically detect meal type based on current hour
function getMealType(){
    const hour = new Date().getHours();
    if(hour >= 7 && hour < 10) return "breakfast";
    if(hour >= 12 && hour < 15) return "lunch";
    if(hour >= 19 && hour < 21) return "dinner";
    return "lunch"; // default
}

// Render scanned users table
function renderTable(){
    const tbody = document.querySelector('#scannedUsersTable tbody');
    tbody.innerHTML = '';
    let i = 1;
    for(let key in scannedUsers){
        const u = scannedUsers[key];
        tbody.innerHTML += `<tr>
            <td>${i++}</td>
            <td>${u.name}</td>
            <td>${u.email}</td>
            <td>${u.course}</td>
            <td>${u.total_scans}</td>
        </tr>`;
    }
}

// Initialize QR scanner
const html5QrcodeScanner = new Html5QrcodeScanner(
    "reader", { fps: 10, qrbox: 250 }
);

function onScanSuccess(decodedText, decodedResult){
    console.log("QR Scanned:", decodedText);

    let user_id = null;
    try {
        const parts = decodedText.split(",");
        for(let p of parts){
            if(p.startsWith("user_id:")){
                user_id = p.split(":")[1];
                break;
            }
        }
    } catch(e){
        console.error("QR parse error:", e);
    }

    if(!user_id){
        alert("‚ùå Invalid QR code");
        return;
    }

    fetch('/admin/scan_qr', {
        method: 'POST',
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ user_id: user_id, meal_type: getMealType() })
    })
    .then(res => res.json())
    .then(data => {
        if(data.success){
            alert(`‚úÖ ${data.name} scanned successfully. Total: ${data.count}`);

            scannedUsers[data.name] = {
                name: data.name,
                email: data.email || '',
                course: data.course || '',
                total_scans: data.count
            };
            renderTable();
        } else {
            alert(`‚ùå ${data.message}`);
        }
    })
    .catch(err => {
        console.error(err);
        alert("‚ùå Network or server error");
    });
}

// Start scanner
html5QrcodeScanner.render(onScanSuccess);
</script>
{% endblock %}
