{% extends "admin_base.html" %}
{% block content %}
<div class="container mt-4">
  <h2>ðŸ“¡ QR Scanner</h2>

  <!-- Date display -->
  <div class="mb-3">
    <strong>Today's Date:</strong> {{ current_date }}
  </div>

  <!-- Last scanned user display -->
  <div id="lastScanned" class="mb-3" style="border:1px solid #ccc; padding:10px; min-height:80px;">
    <strong>Last Scanned User:</strong>
    <div id="userInfo">No scans yet</div>
  </div>

  <!-- Meal selector -->
  <div class="mb-3">
    <label for="mealType" class="form-label">Select Meal</label>
    <select id="mealType" class="form-select">
      <option value="breakfast">Breakfast (07:30 - 09:00)</option>
      <option value="lunch">Lunch (12:00 - 14:00)</option>
      <option value="dinner">Dinner (19:30 - 23:59)</option>
    </select>
  </div>

  <video id="preview" width="400" style="border:1px solid #ccc;"></video>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/instascan/1.0.0/instascan.min.js"></script>
<script>
const mealTimes = {
  breakfast: { start: "07:30", end: "09:00" },
  lunch: { start: "12:00", end: "14:00" },
  dinner: { start: "19:30", end: "23:59" }
};

const mealSelect = document.getElementById("mealType");
const userInfoDiv = document.getElementById("userInfo");

function timeToMinutes(t) {
  const [h, m] = t.split(":").map(Number);
  return h * 60 + m;
}

function isWithinSlot(meal) {
  const now = new Date();
  const currentMinutes = now.getHours() * 60 + now.getMinutes();
  const slot = mealTimes[meal];
  return currentMinutes >= timeToMinutes(slot.start) && currentMinutes <= timeToMinutes(slot.end);
}

function updateLastScannedUser(data, meal){
  const today = new Date().toISOString().split('T')[0];
  userInfoDiv.innerHTML = `
    <strong>Name:</strong> ${data.name} <br>
    <strong>Email:</strong> ${data.email || '-'} <br>
    <strong>Course:</strong> ${data.course || '-'} <br>
    <strong>Meal:</strong> ${meal} <br>
    <strong>Total Scans:</strong> ${data.count} <br>
    <strong>Date:</strong> ${today}
  `;
}

// QR scanner
let scanner = new Instascan.Scanner({ video: document.getElementById('preview') });
scanner.addListener('scan', function(content) {
    const selectedMeal = mealSelect.value;

    if(!isWithinSlot(selectedMeal)){
      return; // silently ignore scans outside slot
    }

    fetch('/admin/scan_qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: content, meal_type: selectedMeal })
    })
    .then(res => res.json())
    .then(data => {
        if(data.success){
            updateLastScannedUser(data, selectedMeal);
        }
    })
    .catch(err => console.error(err));
});

// Start camera
Instascan.Camera.getCameras().then(function (cameras) {
    if (cameras.length > 0) scanner.start(cameras[0]);
    else console.warn("No cameras found.");
}).catch(function (e) {
    console.error(e);
});
</script>
{% endblock %}
