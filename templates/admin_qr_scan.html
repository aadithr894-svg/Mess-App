{% extends "admin_base.html" %}
{% block content %}
<div class="container mt-4">
  <h2>üì° QR Scanner</h2>
  <div class="mb-3"><strong>Today's Date:</strong> {{ current_date }}</div>

  <!-- Last scanned user -->
  <h4>Last Scanned User</h4>
  <table class="table table-bordered table-striped" id="lastScannedUser">
    <thead>
      <tr>
        <th>Name</th>
        <th>Email</th>
        <th>Course</th>
        <th>Meal</th>
        <th>Total Scans</th>
      </tr>
    </thead>
    <tbody>
      <tr><td colspan="5" style="text-align:center;">No scans yet</td></tr>
    </tbody>
  </table>

  <!-- QR Scanner -->
  <div id="reader" style="width:400px;height:300px;border:1px solid #ccc;"></div>
  <div id="result" class="mt-3 text-center text-success"></div>
</div>

<script src="https://unpkg.com/html5-qrcode@2.3.10/minified/html5-qrcode.min.js"></script>
<script>
  const lastUserTbody = document.querySelector('#lastScannedUser tbody');
  const resultDiv = document.getElementById("result");
  let lastScanTime = 0;

  function detectMeal() {
    const now = new Date();
    const hours = now.getHours() + now.getMinutes()/60;
    if(hours >= 7.5 && hours <= 9) return 'breakfast';
    if(hours >= 12 && hours <= 14) return 'lunch';
    return 'dinner';
  }

  function updateLastScanned(data, meal) {
    lastUserTbody.innerHTML = `
      <tr>
        <td>${data.name}</td>
        <td>${data.email}</td>
        <td>${data.course}</td>
        <td>${meal}</td>
        <td>${data.count}</td>
      </tr>
    `;
  }

  function onScanSuccess(decodedText) {
    const now = Date.now();
    if (now - lastScanTime < 2000) return; // throttle 2s
    lastScanTime = now;

    let user_id = null;
    try {
      const parts = decodedText.split(",");
      for (let p of parts) {
        if (p.startsWith("user_id:")) {
          user_id = p.split(":")[1];
          break;
        }
      }
    } catch (e) { console.error("QR parse error:", e); }

    if (!user_id) {
      resultDiv.innerText = "‚ùå Invalid QR code!";
      return;
    }

    const meal = detectMeal();
    fetch("/admin/scan_qr", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ user_id: user_id, meal_type: meal })
    })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        resultDiv.innerText = `‚úÖ ${data.name} marked for ${meal}. Total: ${data.count}`;
        updateLastScanned(data, meal);
      } else {
        resultDiv.innerText = `‚ùå ${data.message}`;
      }
    })
    .catch(err => {
      console.error(err);
      resultDiv.innerText = "‚ùå Server error.";
    });
  }

  function onScanFailure(error) {
    // Ignore scan errors
  }

  const html5QrcodeScanner = new Html5QrcodeScanner(
    "reader", { fps: 10, qrbox: 250 }
  );
  html5QrcodeScanner.render(onScanSuccess, onScanFailure);
</script>
{% endblock %}
