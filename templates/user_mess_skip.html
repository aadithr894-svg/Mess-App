{% extends "base.html" %}
{% block content %}
<div class="container mt-5" style="max-width: 850px;">

  <!-- â”€â”€â”€ Mess Skip Form â”€â”€â”€ -->
  <div class="card shadow-lg border-0 rounded-4 mb-5">
    <div class="card-header bg-primary text-white text-center rounded-top-4">
      <h3 class="mb-0">ğŸ½ï¸ Mess Skip Request</h3>
    </div>
    <div class="card-body p-4">
      <form method="POST">

        <!-- Date Picker -->
        <div class="mb-4">
          <label for="skip_date" class="form-label fw-bold">ğŸ“… Select Date:</label>
          <input type="date"
                 name="skip_date"
                 id="skip_date"
                 required
                 class="form-control form-control-lg rounded-3 shadow-sm"
                 onkeydown="return false;">
        </div>

        <!-- Meal Checkboxes -->
        <div class="mb-4">
          <label class="form-label fw-bold">ğŸ¥— Meals to Skip:</label>
          <div class="d-flex flex-wrap gap-4 mt-2">
            <div class="form-check form-switch">
              <input class="form-check-input" type="checkbox" name="breakfast" id="breakfast">
              <label class="form-check-label" for="breakfast">ğŸ³ Breakfast</label>
            </div>
            <div class="form-check form-switch">
              <input class="form-check-input" type="checkbox" name="lunch" id="lunch">
              <label class="form-check-label" for="lunch">ğŸ› Lunch</label>
            </div>
            <div class="form-check form-switch">
              <input class="form-check-input" type="checkbox" name="dinner" id="dinner">
              <label class="form-check-label" for="dinner">ğŸ² Dinner</label>
            </div>
          </div>
        </div>

        <!-- Submit -->
        <div class="text-center">
          <button type="submit" class="btn btn-lg btn-success px-5 shadow-sm">
            âœ… Save Skip
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- â”€â”€â”€ Month Filter â”€â”€â”€ -->
  <form method="get" class="d-flex justify-content-center mb-4">
    <select name="month" class="form-select w-auto me-2">
      <option value="">All Months</option>
      {% for ym in available_months %}
        <option value="{{ ym }}" {% if ym == selected_month %}selected{% endif %}>
          {{ month_name(ym) }}
        </option>
      {% endfor %}
    </select>
    <button type="submit" class="btn btn-primary">Filter</button>
  </form>

  <!-- â”€â”€â”€ Month-wise Skips List â”€â”€â”€ -->
  <h4 class="fw-bold text-center mb-4">ğŸ“œ My Skips</h4>

  {% if sorted_months %}
    {% for ym in sorted_months %}
      <div class="mb-4">
        <h5 class="fw-semibold text-primary border-bottom pb-2">
          {{ month_name(ym) }}
        </h5>

        <div class="list-group shadow-sm">
          {% for s in skips_by_month[ym] %}
          <div class="list-group-item d-flex justify-content-between align-items-center flex-wrap">
            <div>
              <strong>{{ s.skip_date_display }}</strong><br>
              <small>
                {% if s.breakfast %}ğŸ³ Breakfast {% endif %}
                {% if s.lunch %}ğŸ› Lunch {% endif %}
                {% if s.dinner %}ğŸ² Dinner {% endif %}
              </small>
            </div>
            <span class="badge bg-info text-dark rounded-pill">Skipped</span>
          </div>
          {% endfor %}
        </div>
      </div>
    {% endfor %}
  {% else %}
    <div class="alert alert-info text-center mt-3">
      ğŸ™Œ No mess skips for this selection.
    </div>
  {% endif %}

</div>

<!-- Script to enforce skip date rules -->
<script>
  document.addEventListener("DOMContentLoaded", function() {
    const dateInput = document.getElementById("skip_date");
    const now = new Date();

    const tomorrow = new Date();
    tomorrow.setDate(tomorrow.getDate() + 1);

    const dayAfterTomorrow = new Date();
    dayAfterTomorrow.setDate(dayAfterTomorrow.getDate() + 2);

    let minDate;

    if (now.getHours() < 22) {
      // Before 10 PM â†’ tomorrow and beyond
      minDate = tomorrow.toISOString().split("T")[0];
    } else {
      // After 10 PM â†’ day after tomorrow and beyond
      minDate = dayAfterTomorrow.toISOString().split("T")[0];
    }

    dateInput.setAttribute("min", minDate);
    dateInput.addEventListener("keydown", e => e.preventDefault());
  });
</script>
{% endblock %}
