{% extends "base.html" %}
{% block content %}
<div class="container mt-5" style="max-width: 650px;">

  <!-- Flash / AJAX message placeholder -->
  <div id="flash-container"></div>

  <div class="card shadow-lg border-0 rounded-4">
    <div class="card-header bg-primary text-white text-center rounded-top-4">
      <h3 class="mb-0">🍽️ Mess Skip Request</h3>
    </div>

    <div class="card-body p-4">
      <!-- We keep method="POST" for progressive fallback,
           but handle it with JS below -->
      <form id="skipForm" method="POST">

        <!-- Date Picker -->
        <div class="mb-4">
          <label for="skip_date" class="form-label fw-bold">📅 Select Date:</label>
          <input type="date"
                 name="skip_date"
                 id="skip_date"
                 required
                 class="form-control form-control-lg rounded-3 shadow-sm"
                 onkeydown="return false;">
        </div>

        <!-- Meal Checkboxes -->
        <div class="mb-4">
          <label class="form-label fw-bold">🥗 Meals to Skip:</label>
          <div class="d-flex flex-wrap gap-4 mt-2">
            <div class="form-check form-switch">
              <input class="form-check-input" type="checkbox" name="breakfast" id="breakfast">
              <label class="form-check-label" for="breakfast">🍳 Breakfast</label>
            </div>
            <div class="form-check form-switch">
              <input class="form-check-input" type="checkbox" name="lunch" id="lunch">
              <label class="form-check-label" for="lunch">🍛 Lunch</label>
            </div>
            <div class="form-check form-switch">
              <input class="form-check-input" type="checkbox" name="dinner" id="dinner">
              <label class="form-check-label" for="dinner">🍲 Dinner</label>
            </div>
          </div>
        </div>

        <!-- Submit -->
        <div class="text-center">
          <button type="submit" class="btn btn-lg btn-success px-5 shadow-sm">
            ✅ Save Skip
          </button>
        </div>

      </form>
    </div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {
  // -------- Date rule (tomorrow / day-after depending on 10 PM) ----------
  const dateInput = document.getElementById("skip_date");
  const now = new Date();
  const tomorrow = new Date();  tomorrow.setDate(tomorrow.getDate() + 1);
  const dayAfter = new Date();  dayAfter.setDate(dayAfter.getDate() + 2);
  dateInput.min = (now.getHours() < 22 ? tomorrow : dayAfter)
                    .toISOString().split("T")[0];

  // -------- AJAX submit for instant feedback -----------------------------
  document.getElementById("skipForm").addEventListener("submit", function(e){
    e.preventDefault();
    const formData = new FormData(this);

    fetch("{{ url_for('mess_skip') }}", {
      method: "POST",
      body: formData
    })
    .then(r => r.json())
    .then(data => {
      const flashBox = document.getElementById("flash-container");
      flashBox.innerHTML = `
        <div class="alert alert-${data.status === 'success' ? 'success' : 'danger'}
                    alert-dismissible fade show mb-4">
          ${data.message}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
      `;
      if (data.status === 'success') this.reset();
    })
    .catch(() => {
      document.getElementById("flash-container").innerHTML = `
        <div class="alert alert-danger alert-dismissible fade show mb-4">
          ❌ Something went wrong. Please try again.
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
      `;
    });
  });
});
</script>
{% endblock %}
